<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing Management - Markan Cafe</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="../css/responsive.css">
</head>
<body class="admin-body">
    <div class="admin-wrapper">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <img src="../assets/images/logo.png" alt="Markan Cafe" onerror="this.src='https://via.placeholder.com/60x60/8B4513/FFD700?text=MC'">
                <h3>Markan Cafe</h3>
                <p>Admin Panel</p>
            </div>
            
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="dashboard.html"><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
                    <li><a href="menu-management.html"><i class="fas fa-utensils"></i> <span>Menu Management</span></a></li>
                    <li><a href="orders.html"><i class="fas fa-clipboard-list"></i> <span>Orders</span></a></li>
                    <li><a href="reservations.html"><i class="fas fa-calendar-check"></i> <span>Reservations</span></a></li>
                    <li><a href="users.html"><i class="fas fa-users"></i> <span>Users</span></a></li>
                    <li><a href="billing.html" class="active"><i class="fas fa-receipt"></i> <span>Billing</span></a></li>
                    <li><a href="profile.html"><i class="fas fa-user-cog"></i> <span>Profile</span></a></li>
                    <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <!-- Top Header -->
            <header class="admin-top-header">
                <div class="header-search">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchBill" placeholder="Search invoices...">
                </div>
                <div class="header-user">
                    <div class="header-notifications">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">3</span>
                    </div>
                    <div class="header-profile">
                        <img src="../assets/images/team/admin.jpg" alt="Admin" onerror="this.src='https://via.placeholder.com/40x40/8B4513/FFD700?text=Admin'">
                        <div class="profile-info">
                            <h4 id="adminName">Admin User</h4>
                            <p>Administrator</p>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Header -->
            <div class="page-header">
                <h1>Billing & Invoices</h1>
                <button class="btn btn-primary" onclick="generateNewInvoice()">
                    <i class="fas fa-file-invoice"></i> Generate Invoice
                </button>
            </div>

            <!-- Summary Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalRevenue">$0</h3>
                        <p>Total Revenue</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-file-invoice"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalInvoices">0</h3>
                        <p>Total Invoices</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="paidInvoices">0</h3>
                        <p>Paid Invoices</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="pendingInvoices">0</h3>
                        <p>Pending Invoices</p>
                    </div>
                </div>
            </div>

            <!-- Invoice Generation Section -->
            <div class="chart-card" style="margin-bottom: 30px;">
                <h3>Generate New Invoice</h3>
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                    <div>
                        <select id="orderSelect" class="form-control" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd;">
                            <option value="">Select Order to Invoice</option>
                            <!-- Will be populated by JS -->
                        </select>
                    </div>
                    <div>
                        <button class="btn btn-primary" style="width: 100%;" onclick="generateInvoice()">
                            <i class="fas fa-file-invoice"></i> Generate Invoice
                        </button>
                    </div>
                </div>
            </div>

            <!-- Invoices Table -->
            <div class="chart-card">
                <h3>Recent Invoices</h3>
                <div class="table-responsive">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesTable">
                            <!-- Will be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Invoice Modal -->
    <div class="modal" id="invoiceModal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3>Invoice Details</h3>
                <button class="modal-close" onclick="closeInvoiceModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="invoiceDetails" style="max-height: 70vh; overflow-y: auto;">
                <!-- Will be populated by JS -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-success" onclick="markAsPaid()">Mark as Paid</button>
                <button class="btn btn-primary" onclick="printInvoice()">
                    <i class="fas fa-print"></i> Print
                </button>
                <button class="btn btn-outline" onclick="closeInvoiceModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <script src="../js/main.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Check admin authentication
        if (!Auth.requireAdmin()) {
            window.location.href = '../login.html';
        }

        let invoices = [];
        let orders = [];
        let currentInvoiceId = null;

        document.addEventListener('DOMContentLoaded', function() {
            updateAdminName();
            loadData();
            setupEventListeners();
        });

        function updateAdminName() {
            const user = Auth.getCurrentUser();
            if (user) {
                document.getElementById('adminName').textContent = user.name;
            }
        }

        function loadData() {
            // Mock orders data
            orders = [
                { id: 'ORD-1001', customer: 'John Customer', items: 3, total: 45.50, date: '2025-02-20', status: 'completed' },
                { id: 'ORD-1002', customer: 'Sarah Wilson', items: 2, total: 32.80, date: '2025-02-20', status: 'completed' },
                { id: 'ORD-1003', customer: 'Mike Johnson', items: 4, total: 67.25, date: '2025-02-19', status: 'completed' },
                { id: 'ORD-1004', customer: 'Emma Davis', items: 1, total: 12.99, date: '2025-02-19', status: 'preparing' }
            ];

            // Mock invoices data
            invoices = [
                { 
                    id: 'INV-1001', 
                    orderId: 'ORD-1001', 
                    customer: 'John Customer',
                    date: '2025-02-20', 
                    amount: 45.50,
                    status: 'paid',
                    items: [
                        { name: 'Ethiopian Coffee', quantity: 2, price: 4.50 },
                        { name: 'Sambusa', quantity: 1, price: 3.50 }
                    ]
                },
                { 
                    id: 'INV-1002', 
                    orderId: 'ORD-1002', 
                    customer: 'Sarah Wilson',
                    date: '2025-02-20', 
                    amount: 32.80,
                    status: 'paid',
                    items: [
                        { name: 'Doro Wat', quantity: 1, price: 12.99 },
                        { name: 'Injera', quantity: 2, price: 2.50 }
                    ]
                },
                { 
                    id: 'INV-1003', 
                    orderId: 'ORD-1003', 
                    customer: 'Mike Johnson',
                    date: '2025-02-19', 
                    amount: 67.25,
                    status: 'pending',
                    items: [
                        { name: 'Kitfo', quantity: 1, price: 14.50 },
                        { name: 'Tibs', quantity: 1, price: 13.50 },
                        { name: 'Honey Bread', quantity: 2, price: 4.99 }
                    ]
                }
            ];

            updateStats();
            populateOrderSelect();
            displayInvoices(invoices);
        }

        function updateStats() {
            const totalRevenue = invoices.reduce((sum, inv) => sum + inv.amount, 0);
            const paidInvoices = invoices.filter(inv => inv.status === 'paid').length;
            const pendingInvoices = invoices.filter(inv => inv.status === 'pending').length;

            document.getElementById('totalRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
            document.getElementById('totalInvoices').textContent = invoices.length;
            document.getElementById('paidInvoices').textContent = paidInvoices;
            document.getElementById('pendingInvoices').textContent = pendingInvoices;
        }

        function populateOrderSelect() {
            const select = document.getElementById('orderSelect');
            const completedOrders = orders.filter(o => o.status === 'completed');
            
            // Check if orders already have invoices
            const invoicedOrders = invoices.map(inv => inv.orderId);
            const availableOrders = completedOrders.filter(o => !invoicedOrders.includes(o.id));

            select.innerHTML = '<option value="">Select Order to Invoice</option>';
            availableOrders.forEach(order => {
                const option = document.createElement('option');
                option.value = order.id;
                option.textContent = `${order.id} - ${order.customer} - $${order.total.toFixed(2)}`;
                select.appendChild(option);
            });
        }

        function generateInvoice() {
            const orderId = document.getElementById('orderSelect').value;
            if (!orderId) {
                showNotification('Please select an order', 'warning');
                return;
            }

            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            const newInvoice = {
                id: `INV-${Date.now().toString().slice(-4)}`,
                orderId: order.id,
                customer: order.customer,
                date: new Date().toISOString().split('T')[0],
                amount: order.total,
                status: 'pending',
                items: order.items || [
                    { name: 'Item 1', quantity: 1, price: order.total }
                ]
            };

            invoices.push(newInvoice);
            updateStats();
            displayInvoices(invoices);
            populateOrderSelect();
            showNotification('Invoice generated successfully', 'success');
        }

        function generateNewInvoice() {
            document.getElementById('orderSelect').value = '';
            showNotification('Select an order from the dropdown to generate invoice', 'info');
        }

        function viewInvoice(invoiceId) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;

            currentInvoiceId = invoiceId;

            const itemsHtml = invoice.items.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>$${item.price.toFixed(2)}</td>
                    <td>$${(item.price * item.quantity).toFixed(2)}</td>
                </tr>
            `).join('');

            document.getElementById('invoiceDetails').innerHTML = `
                <div style="padding: 20px; background: #f8f9fa; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h2 style="color: #8B4513; margin: 0;">Markan Cafe</h2>
                            <p style="margin: 5px 0;">Debre Birhan University</p>
                        </div>
                        <div style="text-align: right;">
                            <h3 style="margin: 0;">INVOICE</h3>
                            <p style="margin: 5px 0;">${invoice.id}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <p><strong>Bill To:</strong></p>
                            <p>${invoice.customer}</p>
                        </div>
                        <div>
                            <p><strong>Invoice Date:</strong> ${invoice.date}</p>
                            <p><strong>Status:</strong> <span class="status-badge ${invoice.status}">${invoice.status}</span></p>
                        </div>
                    </div>
                    
                    <table class="admin-table" style="margin-bottom: 20px;">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>
                    
                    <div style="text-align: right;">
                        <p><strong>Subtotal:</strong> $${invoice.amount.toFixed(2)}</p>
                        <p><strong>Tax (10%):</strong> $${(invoice.amount * 0.1).toFixed(2)}</p>
                        <h3><strong>Total:</strong> $${(invoice.amount * 1.1).toFixed(2)}</h3>
                    </div>
                </div>
            `;

            document.getElementById('invoiceModal').classList.add('active');
        }

        function markAsPaid() {
            if (currentInvoiceId) {
                const index = invoices.findIndex(inv => inv.id === currentInvoiceId);
                if (index !== -1) {
                    invoices[index].status = 'paid';
                    displayInvoices(invoices);
                    updateStats();
                    showNotification('Invoice marked as paid', 'success');
                    closeInvoiceModal();
                }
            }
        }

        function printInvoice() {
            window.print();
        }

        function displayInvoices(invoicesToShow) {
            const tbody = document.getElementById('invoicesTable');
            tbody.innerHTML = invoicesToShow.map(inv => `
                <tr>
                    <td>${inv.id}</td>
                    <td>${inv.orderId}</td>
                    <td>${inv.customer}</td>
                    <td>${inv.date}</td>
                    <td>$${inv.amount.toFixed(2)}</td>
                    <td><span class="status-badge ${inv.status}">${inv.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view" onclick="viewInvoice('${inv.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" onclick="markAsPaidFromList('${inv.id}')" ${inv.status === 'paid' ? 'disabled' : ''}>
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function markAsPaidFromList(invoiceId) {
            const index = invoices.findIndex(inv => inv.id === invoiceId);
            if (index !== -1 && invoices[index].status !== 'paid') {
                invoices[index].status = 'paid';
                displayInvoices(invoices);
                updateStats();
                showNotification('Invoice marked as paid', 'success');
            }
        }

        function closeInvoiceModal() {
            document.getElementById('invoiceModal').classList.remove('active');
            currentInvoiceId = null;
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchBill').value.toLowerCase();

            let filtered = invoices.filter(inv => 
                inv.id.toLowerCase().includes(searchTerm) ||
                inv.orderId.toLowerCase().includes(searchTerm) ||
                inv.customer.toLowerCase().includes(searchTerm)
            );

            displayInvoices(filtered);
        }

        function setupEventListeners() {
            document.getElementById('searchBill').addEventListener('input', applyFilters);
        }

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            Auth.logout();
        });
    </script>
</body>
</html>